@page "/join/{inviteCode?}"
@rendermode InteractiveServer
@using ScioApp.Services
@using ScioApp.Models
@inject IStudentService StudentService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<PageTitle>Připojit se ke skupině - Scio</PageTitle>

<div class="auth-container fade-in px-3">
    <div class="auth-card glass-card">
        <div class="text-center mb-4">
            <div class="d-inline-flex align-items-center justify-content-center bg-primary text-white rounded-circle mb-3 shadow-sm" style="width: 60px; height: 60px;">
                <span class="bi bi-mortarboard-fill h3 mb-0"></span>
            </div>
            <h1>Vstup do výuky</h1>
            <p>Zadejte údaje pro připojení ke své skupině</p>
        </div>

        <AuthorizeView>
            <Authorized>
                <div class="alert bg-light-danger text-danger border-0 small py-2 mb-4 rounded-3 fade-in shadow-xs">
                    <div class="fw-bold d-flex align-items-center gap-2">
                        <span class="bi bi-exclamation-triangle-fill"></span> 
                        <span>Pozor: Testujete jako učitel</span>
                    </div>
                    <div class="mt-1" style="font-size: 0.8rem; opacity: 0.9;">
                        Jste přihlášen jako <strong>@context.User.Identity?.Name</strong>. 
                        Pro správné testování žáka použijte <strong>Anonymní okno</strong>.
                    </div>
                    <div class="mt-2 text-end">
                        <a href="auth/logout" class="btn btn-sm btn-link text-danger p-0 fw-bold x-small text-decoration-none">
                            <span class="bi bi-box-arrow-right"></span> Odhlásit učitele
                        </a>
                    </div>
                </div>
            </Authorized>
        </AuthorizeView>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger border-0 rounded-3 small mb-4 fade-in">
                <span class="bi bi-x-circle-fill me-2"></span> @errorMessage
            </div>
        }

        <div class="form-group mb-3">
            <label class="x-small fw-bold text-muted uppercase-title mb-1">Kód skupiny</label>
            <div class="input-group">
                <span class="input-group-text bg-light border-0"><span class="bi bi-hash text-primary"></span></span>
                <input id="inviteCode" @bind="InviteCode" class="form-control border-0 bg-light" 
                       placeholder="NAPŘ. ABC123XY" readonly="@(!string.IsNullOrEmpty(inviteCode))" />
            </div>
        </div>

        <div class="form-group mb-4">
            <label class="x-small fw-bold text-muted uppercase-title mb-1">Tvoje přezdívka</label>
            <div class="input-group">
                <span class="input-group-text bg-light border-0"><span class="bi bi-person text-primary"></span></span>
                <input id="nickname" @bind="Nickname" class="form-control border-0 bg-light" 
                       placeholder="Např. SuperMatematik" />
            </div>
        </div>

        <button @onclick="HandleJoin" class="btn btn-primary w-100 py-3 shadow-md" disabled="@isSubmitting">
            @if (isSubmitting)
            {
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                <span class="fw-bold">Připojuji se...</span>
            }
            else
            {
                <span class="fw-bold">Vstoupit do skupiny</span>
            }
        </button>

        <div class="mt-4 text-center">
            <div class="x-small text-muted">Aplikace Scio &copy; 2026</div>
        </div>
    </div>
</div>

@code {
    [Parameter] public string? inviteCode { get; set; }
    
    private string InviteCode { get; set; } = "";
    private string Nickname { get; set; } = "";
    private string? errorMessage;
    private bool isSubmitting = false;

    protected override void OnInitialized()
    {
        if (!string.IsNullOrEmpty(inviteCode))
        {
            InviteCode = inviteCode;
        }
    }

    private async Task HandleJoin()
    {
        if (string.IsNullOrWhiteSpace(InviteCode))
        {
            errorMessage = "Prosím, zadejte kód skupiny.";
            return;
        }

        if (string.IsNullOrWhiteSpace(Nickname))
        {
            errorMessage = "Prosím, zadejte svou přezdívku.";
            return;
        }

        isSubmitting = true;
        errorMessage = null;

        try
        {
            var deviceId = await GetOrCreateDeviceId();
            var result = await StudentService.JoinGroupAsync(InviteCode.Trim().ToUpper(), Nickname.Trim(), deviceId);

            if (result.Success && result.Student != null)
            {
                // Save info to local storage for persistence
                await JSRuntime.InvokeVoidAsync("localStorage.setItem", $"scio_group_{result.Student.GroupId}_nick", result.Student.Nickname);
                
                // Navigate with identifiers as backup in case local storage sync is slow (race condition fix)
                NavigationManager.NavigateTo($"chat/{result.Student.GroupId}?nick={Uri.EscapeDataString(result.Student.Nickname)}&device={deviceId}");
            }
            else
            {
                errorMessage = result.Message;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Chyba připojení: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task<string> GetOrCreateDeviceId()
    {
        var deviceId = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "scio_device_id");
        if (string.IsNullOrEmpty(deviceId))
        {
            deviceId = Guid.NewGuid().ToString();
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "scio_device_id", deviceId);
        }
        return deviceId;
    }
}

<style>
    .uppercase-title {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .shadow-md {
        box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.1), 0 2px 4px -2px rgba(79, 70, 229, 0.1);
    }
    .input-group-text { border-radius: 0.5rem 0 0 0.5rem; }
    .form-control { border-radius: 0 0.5rem 0.5rem 0; }
</style>
