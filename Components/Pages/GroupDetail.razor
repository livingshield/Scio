@page "/group/{GroupId:int}"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.SignalR.Client
@using ScioApp.Models
@using ScioApp.Services
@attribute [Authorize]
@inject IGroupService GroupService
@inject IStudentService StudentService
@inject IEmailService EmailService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>Dashboard skupiny - Scio</PageTitle>

<div class="container-fluid py-4 fade-in">
    <!-- Header -->
    <div class="glass-card p-4 mb-4 d-flex flex-wrap justify-content-between align-items-center gap-3">
        <div class="d-flex align-items-center gap-3">
            <button class="btn btn-outline-light rounded-circle" @onclick='() => NavigationManager.NavigateTo("")' style="width: 40px; height: 40px; padding: 0;">
                <span class="bi bi-arrow-left"></span>
            </button>
            <div>
                <h1 class="h4 fw-bold mb-0">@group?.Name</h1>
                <p class="text-muted small mb-0">Správa skupiny a sledování pokroku</p>
            </div>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" @onclick="ShowInviteModal">
                <span class="bi bi-share me-2"></span>Pozvat žáky
            </button>
            <button class="btn btn-primary-custom" @onclick="ToggleGroupStatus">
                <span class="bi @(group?.IsActive == true ? "bi-pause-fill" : "bi-play-fill") me-2"></span>
                @(group?.IsActive == true ? "Pozastavit skupinu" : "Aktivovat skupinu")
            </button>
        </div>
    </div>

    <div class="row g-4">
        <!-- Main Stats & Student List -->
        <div class="col-xl-8">
            <!-- Stats -->
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <div class="glass-card p-4 text-center">
                        <div class="text-muted small fw-bold mb-1 uppercase-title">AKTIVNÍ ŽÁCI</div>
                        <div class="h2 fw-bold text-primary mb-0">@(students?.Count(s => s.Status == StudentStatus.Active || s.Status == StudentStatus.NeedHelp) ?? 0)</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="glass-card p-4 text-center">
                        <div class="text-muted small fw-bold mb-1 uppercase-title">PRŮMĚRNÝ POKROK</div>
                        <div class="h2 fw-bold text-success mb-0">@(students?.Any() == true ? (int)students.Average(s => s.ProgressLog?.Percentage ?? 0) : 0)%</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="glass-card p-4 text-center border @(students?.Any(s => s.Status == StudentStatus.NeedHelp) == true ? "border-danger pulse-border" : "border-white-10")">
                        <div class="text-muted small fw-bold mb-1 uppercase-title">VYŽADUJE POMOC</div>
                        <div class="h2 fw-bold @(students?.Any(s => s.Status == StudentStatus.NeedHelp) == true ? "text-danger" : "text-muted") mb-0">
                            @(students?.Count(s => s.Status == StudentStatus.NeedHelp) ?? 0)
                        </div>
                    </div>
                </div>
            </div>

            <!-- Student Grid -->
            <div class="glass-card p-4">
                <h5 class="fw-bold mb-4">Seznam žáků</h5>
                <div class="row g-3">
                    @if (students != null)
                    {
                        @foreach (var student in students)
                        {
                            var isOnline = (DateTime.UtcNow - student.LastActivityAt).TotalSeconds < 120;
                            <div class="col-md-6 col-lg-4">
                                <div class="p-3 rounded-4 bg-white-5 border @(selectedStudent?.Id == student.Id ? "border-primary" : "border-white-10") transition-all">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div class="d-flex align-items-center gap-2 flex-grow-1 cursor-pointer" @onclick="() => SelectStudent(student)">
                                            <div class="fw-bold text-truncate" style="max-width: 100px;">@student.Nickname</div>
                                            <span class="status-dot @(isOnline ? "bg-success" : "bg-secondary")" title="@(isOnline ? "Online" : "Offline")" style="width: 8px; height: 8px; border-radius: 50%; display: inline-block;"></span>
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="status-orb @GetStatusClass(student)"></span>
                                            <button class="btn btn-sm btn-outline-danger border-0 p-1" 
                                                    @onclick="() => RemoveStudent(student.Id)" 
                                                    @onclick:stopPropagation="true"
                                                    title="Odebrat studenta">
                                                <span class="bi bi-x-lg" style="font-size: 0.75rem;"></span>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="progress bg-dark mb-2" style="height: 6px; border-radius: 3px;">
                                        <div class="progress-bar bg-primary-custom" style="width: @(student.ProgressLog?.Percentage ?? 0)%"></div>
                                    </div>
                                    <div class="d-flex justify-content-between small text-muted">
                                        <span>Pokrok: @((int)(student.ProgressLog?.Percentage ?? 0))%</span>
                                        @if (student.Status == StudentStatus.NeedHelp)
                                        {
                                            <span class="text-danger fw-bold pulse-text">POMOC!</span>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>

        <!-- Detail Panel -->
        <div class="col-xl-4">
            <div class="glass-card h-100 d-flex flex-column overflow-hidden">
                <div class="p-4 border-bottom border-white-10">
                    <h5 class="fw-bold mb-0">Detail aktivity</h5>
                    @if (selectedStudent != null)
                    {
                        <div class="mt-3 d-flex justify-content-between align-items-center">
                            <span class="h6 mb-0">@selectedStudent.Nickname</span>
                            @if (selectedStudent.Status == StudentStatus.NeedHelp)
                            {
                                <button class="btn btn-sm btn-success rounded-pill px-3" @onclick="ResolveHelp">
                                    Vyřešeno
                                </button>
                            }
                        </div>
                    }
                </div>

                <div class="flex-grow-1 p-3 overflow-auto d-flex flex-column gap-3" style="max-height: 500px;">
                    @if (selectedStudent == null)
                    {
                        <div class="text-center py-5 opacity-50">
                            <span class="bi bi-person-bounding-box h1 d-block mb-3"></span>
                            <p>Vyberte žáka pro zobrazení zpráv</p>
                        </div>
                    }
                    else if (selectedStudentMessages == null || !selectedStudentMessages.Any())
                    {
                        <p class="text-center py-4 text-muted small">Žádné zprávy od tohoto žáka.</p>
                    }
                    else
                    {
                        @foreach (var msg in selectedStudentMessages)
                        {
                            <div class="p-3 rounded-4 @(msg.IsFromTeacher ? "bg-purple-soft border-purple" : "bg-white-5") @(msg.IsProgressContribution ? "border-success-soft" : "")">
                                <div class="d-flex justify-content-between small opacity-50 mb-1">
                                    <span>@(msg.IsFromTeacher ? "Vy" : selectedStudent.Nickname)</span>
                                    <span>@msg.Timestamp.ToLocalTime().ToString("HH:mm")</span>
                                </div>
                                <div class="small">@msg.Content</div>
                                @if (msg.IsProgressContribution)
                                {
                                    <div class="mt-2 text-success small fw-bold">
                                        <span class="bi bi-check2-circle"></span> Potvrzený pokrok
                                    </div>
                                }
                            </div>
                        }
                    }
                </div>

                @if (selectedStudent != null)
                {
                    <div class="p-3 border-top border-white-10 bg-black-20">
                        <div class="input-group">
                            <input type="text" @bind="teacherMessage" @bind:event="oninput" @onkeydown="HandleTeacherMsgKey" class="form-control form-control-custom" placeholder="Odpovědět žákovi..." />
                            <button class="btn btn-primary-custom" @onclick="SendTeacherMessage" disabled="@string.IsNullOrWhiteSpace(teacherMessage)">
                                <span class="bi bi-send"></span>
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@if (isInviteModalVisible)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="glass-card modal-content border-0">
                <div class="modal-header border-bottom border-white-10 px-4 py-3">
                    <h5 class="fw-bold mb-0">Pozvat žáky do výuky</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="HideInviteModal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-4 p-3 rounded-4 bg-white-5 border border-white-10 text-center">
                        <div class="small fw-bold text-muted uppercase-title mb-1">PŘÍSTUPOVÝ KÓD</div>
                        <div class="h3 fw-bold text-primary mb-0" style="letter-spacing: 2px;">@group?.InviteCode</div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label small fw-bold text-muted mb-2">EMAILOVÉ ADRESY (oddělené středníkem)</label>
                        <textarea @bind="inviteEmails" class="form-control form-control-custom" rows="3" placeholder="student1@skola.cz; student2@skola.cz"></textarea>
                    </div>

                    @if (!string.IsNullOrEmpty(inviteStatus))
                    {
                        <div class="alert @(inviteStatus.Contains("Chyba") ? "alert-danger" : "alert-success") border-0 small py-2 mb-3 rounded-3">
                            @inviteStatus
                        </div>
                    }

                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <button class="btn btn-link text-white text-decoration-none" @onclick="HideInviteModal">Zavřít</button>
                        <button class="btn btn-primary-custom px-4" @onclick="SendInvites" disabled="@(string.IsNullOrWhiteSpace(inviteEmails) || isSendingInvites)">
                            @if (isSendingInvites) { <span class="spinner-border spinner-border-sm me-2"></span> }
                            <span class="bi bi-send-fill me-2"></span>Odeslat pozvánky
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .bg-white-5 { background: rgba(255, 255, 255, 0.05); }
    .bg-black-20 { background: rgba(0, 0, 0, 0.2); }
    .border-white-10 { border-color: rgba(255, 255, 255, 0.1) !important; }
    .bg-purple-soft { background: rgba(168, 85, 247, 0.1); }
    .border-purple { border: 1px solid rgba(168, 85, 247, 0.2); }
    .bg-success-soft { background: rgba(34, 197, 94, 0.1); }
    .border-success-soft { border: 1px solid rgba(34, 197, 94, 0.2); }
    .cursor-pointer { cursor: pointer; }
    .transition-all { transition: all 0.2s ease; }
    
    .status-orb { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
    .status-orb.linked { background-color: #00d2ff; box-shadow: 0 0 8px rgba(0, 210, 255, 0.5); }
    .status-orb.help { background-color: #ef4444; box-shadow: 0 0 10px rgba(239, 68, 68, 0.6); animation: pulseRed 1.5s infinite; }
    .status-orb.idle { background-color: #64748b; }
    .status-orb.completed { background-color: #22c55e; box-shadow: 0 0 10px rgba(34, 197, 94, 0.6); }

    @@keyframes pulseRed { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.3); } 100% { opacity: 1; transform: scale(1); } }
    .pulse-border { animation: borderGlow 1.5s infinite; }
    @@keyframes borderGlow { 0% { border-color: rgba(239, 68, 68, 0.2); } 50% { border-color: rgba(239, 68, 68, 1); } 100% { border-color: rgba(239, 68, 68, 0.2); } }
</style>

@code {
    [Parameter] public int GroupId { get; set; }
    private Group? group;
    private List<Student>? students;
    private Student? selectedStudent;
    private List<Message>? selectedStudentMessages;
    private string teacherMessage = "";
    private HubConnection? hubConnection;

    protected override async Task OnInitializedAsync()
    {
        group = await GroupService.GetGroupByIdAsync(GroupId);
        if (group != null)
        {
            students = await GroupService.GetGroupStudentsAsync(GroupId);
            
            hubConnection = new HubConnectionBuilder()
                .WithUrl(NavigationManager.ToAbsoluteUri("sciohub"))
                .WithAutomaticReconnect().Build();

            hubConnection.On<int, int, string, DateTime, bool, bool, string, bool>("ReceiveMessage", async (mid, sid, content, time, isProgress, isRelevant, feedback, isFromTeacher) =>
            {
                if (selectedStudent != null && (sid == selectedStudent.Id || (isFromTeacher && sid == selectedStudent.Id)))
                {
                    selectedStudentMessages = await GroupService.GetStudentMessagesAsync(selectedStudent.Id);
                }
                await InvokeAsync(StateHasChanged);
            });

            hubConnection.On<int, int>("ProgressUpdated", async (sid, val) => {
                var s = students?.FirstOrDefault(x => x.Id == sid);
                if (s != null && s.ProgressLog != null) { s.ProgressLog.CurrentValue = val; await InvokeAsync(StateHasChanged); }
            });

            hubConnection.On<int, StudentStatus>("StatusChanged", async (sid, status) => {
                var s = students?.FirstOrDefault(x => x.Id == sid);
                if (s != null) { s.Status = status; await InvokeAsync(StateHasChanged); }
            });

            hubConnection.On<int, string, string>("StudentJoined", async (gid, sid, nick) => {
                if (gid == GroupId) { students = await GroupService.GetGroupStudentsAsync(GroupId); await InvokeAsync(StateHasChanged); }
            });

            hubConnection.On<int, DateTime>("ActivityUpdated", async (sid, lastActivity) => {
                var s = students?.FirstOrDefault(x => x.Id == sid);
                if (s != null) { s.LastActivityAt = lastActivity; await InvokeAsync(StateHasChanged); }
            });

            await hubConnection.StartAsync();
            await hubConnection.InvokeAsync("JoinGroup", GroupId, "TEACHER", "TEACHER", true);
        }
    }

    private string GetStatusClass(Student s) => s.Status switch { StudentStatus.NeedHelp => "help", StudentStatus.Active => "linked", StudentStatus.Inactive => "idle", StudentStatus.Completed => "completed", _ => "idle" };

    private async Task SelectStudent(Student s) { selectedStudent = s; selectedStudentMessages = await GroupService.GetStudentMessagesAsync(s.Id); }

    private async Task RemoveStudent(int studentId)
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", "Opravdu chcete odebrat tohoto studenta?"))
            return;
            
        try
        {
            await StudentService.RemoveStudentAsync(studentId);
            students = await GroupService.GetGroupStudentsAsync(GroupId);
            
            if (selectedStudent?.Id == studentId)
                selectedStudent = null;
                
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Chyba při odebírání studenta: {ex.Message}");
        }
    }

    private async Task ToggleGroupStatus() { if (group != null) { group.IsActive = !group.IsActive; await GroupService.UpdateGroupAsync(group); } }

    private async Task ResolveHelp() { if (selectedStudent != null && hubConnection != null) await hubConnection.InvokeAsync("SignalNeedHelp", GroupId, selectedStudent.Id, false); }

    private async Task SendTeacherMessage() {
        if (string.IsNullOrWhiteSpace(teacherMessage) || selectedStudent == null || hubConnection == null) return;
        var msg = teacherMessage; teacherMessage = "";
        await hubConnection.InvokeAsync("SendTeacherMessage", GroupId, selectedStudent.Id, msg);
    }
    private async Task HandleTeacherMsgKey(KeyboardEventArgs e) { if (e.Key == "Enter") await SendTeacherMessage(); }

    public async ValueTask DisposeAsync() { if (hubConnection != null) await hubConnection.DisposeAsync(); }

    private string inviteEmails = "";
    private string inviteStatus = "";
    private bool isSendingInvites = false;
    private bool isInviteModalVisible = false;

    private void ShowInviteModal() { isInviteModalVisible = true; inviteStatus = ""; }
    private void HideInviteModal() => isInviteModalVisible = false;

    private async Task SendInvites()
    {
        if (string.IsNullOrWhiteSpace(inviteEmails) || group == null) return;
        
        isSendingInvites = true;
        inviteStatus = "";
        
        try
        {
            var emails = inviteEmails.Split(';', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
            var inviteUrl = $"{NavigationManager.BaseUri}vstup/{group.InviteCode}";
            await EmailService.SendBulkInviteAsync(emails, group.Name, group.InviteCode, inviteUrl);
            inviteStatus = "Pozvánky byly úspěšně odeslány.";
            inviteEmails = "";
        }
        catch (Exception ex)
        {
            inviteStatus = $"Chyba při odesílání: {ex.Message}";
        }
        finally
        {
            isSendingInvites = false;
        }
    }
}
