@page "/register"
@rendermode InteractiveServer
@using ScioApp.Services
@inject IAuthService AuthService
@inject NavigationManager NavigationManager

<PageTitle>Registrace - Scio</PageTitle>

<div class="auth-container px-3 fade-in">
    <div class="auth-card glass-card">
        <div class="text-center mb-4">
            <div class="d-inline-flex align-items-center justify-content-center bg-primary text-white rounded-circle mb-3 shadow-sm" style="width: 60px; height: 60px;">
                <span class="bi bi-person-plus-fill h3 mb-0"></span>
            </div>
            <h1>Vytvořit účet</h1>
            <p>Zaregistrujte se jako učitel a začněte učit moderně</p>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger border-0 rounded-3 small mb-4 fade-in">
                <span class="bi bi-x-circle-fill me-2"></span> @errorMessage
            </div>
        }

        <EditForm Model="@registerModel" OnValidSubmit="HandleRegistration">
            <DataAnnotationsValidator />
            
            <div class="form-group mb-3">
                <label class="x-small fw-bold text-muted uppercase-title mb-1">Jméno a příjmení</label>
                <InputText id="name" @bind-Value="registerModel.Name" class="form-control border-0 bg-light py-2" placeholder="např. Jan Novák" />
                <ValidationMessage For="@(() => registerModel.Name)" class="x-small text-danger mt-1" />
            </div>

            <div class="form-group mb-3">
                <label class="x-small fw-bold text-muted uppercase-title mb-1">Uživatelské jméno</label>
                <InputText id="login" @bind-Value="registerModel.Login" class="form-control border-0 bg-light py-2" placeholder="jnovak" />
                <ValidationMessage For="@(() => registerModel.Login)" class="x-small text-danger mt-1" />
            </div>

            <div class="form-group mb-3">
                <label class="x-small fw-bold text-muted uppercase-title mb-1">Emailová adresa</label>
                <InputText id="email" @bind-Value="registerModel.Email" class="form-control border-0 bg-light py-2" placeholder="jan.novak@skola.cz" />
                <ValidationMessage For="@(() => registerModel.Email)" class="x-small text-danger mt-1" />
            </div>

            <div class="form-group mb-4">
                <label class="x-small fw-bold text-muted uppercase-title mb-1">Heslo</label>
                <InputText id="password" type="password" @bind-Value="registerModel.Password" class="form-control border-0 bg-light py-2" placeholder="********" />
                <ValidationMessage For="@(() => registerModel.Password)" class="x-small text-danger mt-1" />
            </div>

            <button type="submit" class="btn btn-primary w-100 py-3 shadow-md fw-bold" disabled="@isSubmitting">
                @if (isSubmitting)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                    <span>Probíhá registrace...</span>
                }
                else
                {
                    <span>Zaregistrovat se</span>
                }
            </button>
        </EditForm>

        <div class="text-center mt-4">
            <span class="text-muted small">Již máte účet?</span> 
            <a href="login" class="fw-bold text-primary small text-decoration-none ms-1">Přihlásit se</a>
        </div>
    </div>
</div>

@code {
    private RegisterModel registerModel = new();
    private string? errorMessage;
    private bool isSubmitting = false;

    private async Task HandleRegistration()
    {
        isSubmitting = true;
        errorMessage = null;

        var result = await AuthService.RegisterTeacherAsync(
            registerModel.Login, 
            registerModel.Email, 
            registerModel.Name, 
            registerModel.Password);

        if (result.Success)
        {
            NavigationManager.NavigateTo("login?registered=true");
        }
        else
        {
            errorMessage = result.Message;
        }

        isSubmitting = false;
    }

    public class RegisterModel
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Povinné")]
        public string Name { get; set; } = "";

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Povinné")]
        public string Login { get; set; } = "";

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Povinné")]
        [System.ComponentModel.DataAnnotations.EmailAddress(ErrorMessage = "Neplatný email")]
        public string Email { get; set; } = "";

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Povinné")]
        [System.ComponentModel.DataAnnotations.MinLength(6, ErrorMessage = "Min. 6 znaků")]
        public string Password { get; set; } = "";
    }
}
