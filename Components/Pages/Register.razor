@page "/register"
@rendermode InteractiveServer
@using ScioApp.Services
@inject IAuthService AuthService
@inject NavigationManager NavigationManager

<PageTitle>Registrace učitele - Scio</PageTitle>

<div class="auth-container">
    <div class="auth-card">
        <h1>Registrace učitele</h1>
        <p>Vytvořte si účet pro správu studentských skupin</p>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }

        <EditForm Model="@registerModel" OnValidSubmit="HandleRegistration">
            <DataAnnotationsValidator />
            
            <div class="form-group">
                <label for="name">Jméno a příjmení</label>
                <InputText id="name" @bind-Value="registerModel.Name" class="form-control" placeholder="Jan Novák" />
                <ValidationMessage For="@(() => registerModel.Name)" />
            </div>

            <div class="form-group">
                <label for="login">Uživatelské jméno (Login)</label>
                <InputText id="login" @bind-Value="registerModel.Login" class="form-control" placeholder="jnovak" />
                <ValidationMessage For="@(() => registerModel.Login)" />
            </div>

            <div class="form-group">
                <label for="email">Email</label>
                <InputText id="email" @bind-Value="registerModel.Email" class="form-control" placeholder="jan.novak@skola.cz" />
                <ValidationMessage For="@(() => registerModel.Email)" />
            </div>

            <div class="form-group">
                <label for="password">Heslo</label>
                <InputText id="password" type="password" @bind-Value="registerModel.Password" class="form-control" placeholder="********" />
                <ValidationMessage For="@(() => registerModel.Password)" />
            </div>

            <button type="submit" class="btn btn-primary w-100" disabled="@isSubmitting">
                @if (isSubmitting)
                {
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    <span> Registruji...</span>
                }
                else
                {
                    <span>Zaregistrovat se</span>
                }
            </button>
        </EditForm>

        <div class="auth-footer">
            Již máte účet? <a href="login">Přihlaste se</a>
        </div>
    </div>
</div>

@code {
    private RegisterModel registerModel = new();
    private string? errorMessage;
    private bool isSubmitting = false;

    private async Task HandleRegistration()
    {
        isSubmitting = true;
        errorMessage = null;

        var result = await AuthService.RegisterTeacherAsync(
            registerModel.Login, 
            registerModel.Email, 
            registerModel.Name, 
            registerModel.Password);

        if (result.Success)
        {
            NavigationManager.NavigateTo("login?registered=true");
        }
        else
        {
            errorMessage = result.Message;
        }

        isSubmitting = false;
    }

    public class RegisterModel
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Jméno je povinné")]
        public string Name { get; set; } = "";

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Login je povinný")]
        public string Login { get; set; } = "";

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Email je povinný")]
        [System.ComponentModel.DataAnnotations.EmailAddress(ErrorMessage = "Neplatný formát emailu")]
        public string Email { get; set; } = "";

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Heslo je povinné")]
        [System.ComponentModel.DataAnnotations.MinLength(6, ErrorMessage = "Heslo musí mít alespoň 6 znaků")]
        public string Password { get; set; } = "";
    }
}
